<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perpustakaan Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        .nav-link {
            position: relative;
            transition: color 0.3s;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: #fff;
            transition: width 0.3s;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .hero-section {
            background: linear-gradient(135deg, #4171f5 0%, #3451b2 100%);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            opacity: 0.3;
        }

        .card {
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4171f5 0%, #3451b2 100%);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(65, 113, 245, 0.3);
        }

        .news-card {
            border-radius: 1rem;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .news-card:hover {
            transform: translateY(-5px);
        }

        .news-card img {
            transition: transform 0.3s;
        }

        .news-card:hover img {
            transform: scale(1.05);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
        }

        .calendar-day:hover {
            background-color: #e2e8f0;
        }

        .event-item {
            transition: transform 0.3s;
        }

        .event-item:hover {
            transform: translateX(5px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-book-reader text-2xl"></i>
                    <span class="text-xl font-bold">Perpustakaan Sekolah</span>
                </div>
                <div class="hidden md:flex items-center space-x-6">
                    <a href="/" class="nav-link hover:text-blue-200">Beranda</a>
                    <a href="#berita" class="nav-link hover:text-blue-200">Berita</a>
                    <a href="#katalog" class="nav-link hover:text-blue-200">Katalog</a>
                    <a href="#acara" class="nav-link hover:text-blue-200">Acara</a>
                    <a href="#submit-book" id="submit-book-link" class="nav-link hover:text-blue-200 hidden">Ajukan Buku</a>
                    <div id="auth-section" class="flex items-center space-x-4">
                        <a href="/login" id="login-link" class="nav-link hover:text-blue-200 px-4 py-2 rounded-lg border-2 border-white hover:bg-white hover:text-blue-600 transition-all duration-300">
                            <i class="fas fa-sign-in-alt mr-2"></i>Login
                        </a>
                        <a href="#admin" id="admin-link" class="nav-link hover:text-blue-200 hidden">
                            <i class="fas fa-cog mr-2"></i>Admin
                        </a>
                        <button id="logout-btn" class="nav-link hover:text-blue-200 hidden px-4 py-2 rounded-lg border-2 border-white hover:bg-white hover:text-blue-600 transition-all duration-300" onclick="logout()">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                        <span id="username-display" class="text-white hidden px-3 py-1 bg-blue-700 rounded-lg">
                            <i class="fas fa-user mr-2"></i><span></span>
                        </span>
                    </div>
                </div>
                <button class="md:hidden">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section text-white py-24 relative">
        <div class="container mx-auto px-4 text-center animate-fade-in">
            <h1 class="text-4xl font-bold mb-4">Selamat Datang di Perpustakaan Sekolah</h1>
            <p class="text-xl mb-8">Temukan ribuan buku dan sumber pengetahuan untuk mendukung pembelajaran Anda</p>
            <div class="flex justify-center space-x-4">
                <a href="#katalog" class="bg-white text-blue-600 px-6 py-2 rounded-full font-semibold hover:bg-blue-100">Lihat Katalog</a>
                <a href="#admin" class="bg-transparent border-2 border-white px-6 py-2 rounded-full font-semibold hover:bg-blue-600">Area Admin</a>
            </div>
        </div>
    </div>

    <!-- Berita Terbaru -->
    <section id="berita" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-12 text-center animate-fade-in">Berita & Pengumuman</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="news-card bg-white rounded-lg shadow-md overflow-hidden">
                    <img src="https://source.unsplash.com/random/800x500/?library" alt="Berita 1" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-2">Program Literasi Baru</h3>
                        <p class="text-gray-600 mb-4">Program membaca 15 menit setiap pagi untuk meningkatkan minat baca siswa.</p>
                        <a href="#" class="text-blue-600 hover:text-blue-800">Baca selengkapnya →</a>
                    </div>
                </div>
                <!-- Berita 2 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <img src="https://source.unsplash.com/random/800x500/?books" alt="Berita 2" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-2">Koleksi Buku Baru</h3>
                        <p class="text-gray-600 mb-4">100 judul buku baru telah ditambahkan ke koleksi perpustakaan.</p>
                        <a href="#" class="text-blue-600 hover:text-blue-800">Baca selengkapnya →</a>
                    </div>
                </div>
                <!-- Berita 3 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <img src="https://source.unsplash.com/random/800x500/?study" alt="Berita 3" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="font-bold text-xl mb-2">Lomba Menulis Cerpen</h3>
                        <p class="text-gray-600 mb-4">Ikuti lomba menulis cerpen dan menangkan hadiah menarik!</p>
                        <a href="#" class="text-blue-600 hover:text-blue-800">Baca selengkapnya →</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Katalog Buku -->
    <section id="katalog" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-12 text-center animate-fade-in">Katalog Buku</h2>
            
            <!-- Filter dan Pencarian -->
            <div class="mb-8 flex flex-wrap gap-4 justify-center">
                <input type="text" placeholder="Cari judul buku..." class="px-4 py-2 border rounded-lg w-full md:w-96">
                <select class="px-4 py-2 border rounded-lg">
                    <option value="">Semua Kategori</option>
                    <option value="fiksi">Fiksi</option>
                    <option value="non-fiksi">Non-Fiksi</option>
                    <option value="pelajaran">Buku Pelajaran</option>
                </select>
            </div>

            <!-- Book Details Modal -->
            <div id="book-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
                <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-2xl font-bold" id="modal-title"></h3>
                            <button onclick="closeBookModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="modal-content"></div>
                    </div>
                </div>
            </div>

            <!-- Daftar Buku -->
            <div class="grid md:grid-cols-4 gap-6" id="daftar-buku">
                <!-- Buku akan ditambahkan secara dinamis melalui JavaScript -->
            </div>

            <!-- User History Section -->
            <div id="user-history" class="mt-12 hidden">
                <h3 class="text-2xl font-bold mb-6">Riwayat Peminjaman</h3>
                <div class="space-y-4" id="history-list">
                    <!-- History items will be added here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Acara -->
    <section id="acara" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-12 text-center animate-fade-in">Kalender Acara</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Kalender -->
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h3 class="font-bold text-xl mb-4">Kalender Kegiatan</h3>
                    <div class="grid grid-cols-7 gap-2 text-center">
                        <div class="font-bold">Min</div>
                        <div class="font-bold">Sen</div>
                        <div class="font-bold">Sel</div>
                        <div class="font-bold">Rab</div>
                        <div class="font-bold">Kam</div>
                        <div class="font-bold">Jum</div>
                        <div class="font-bold">Sab</div>
                        <!-- Tanggal akan ditambahkan secara dinamis -->
                    </div>
                </div>

                <!-- Daftar Acara -->
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h3 class="font-bold text-xl mb-4">Acara Mendatang</h3>
                    <div class="space-y-4">
                        <div class="event-item border-l-4 border-blue-500 pl-4 mb-6 hover:bg-gray-50 p-4 rounded-r-lg">
                            <div class="font-semibold">Bedah Buku "Laskar Pelangi"</div>
                            <div class="text-gray-600">20 November 2023 | 09:00 WIB</div>
                        </div>
                        <div class="event-item border-l-4 border-blue-500 pl-4 mb-6 hover:bg-gray-50 p-4 rounded-r-lg">
                            <div class="font-semibold">Workshop Menulis Kreatif</div>
                            <div class="text-gray-600">25 November 2023 | 13:00 WIB</div>
                        </div>
                        <div class="event-item border-l-4 border-blue-500 pl-4 mb-6 hover:bg-gray-50 p-4 rounded-r-lg">
                            <div class="font-semibold">Diskusi Sastra</div>
                            <div class="text-gray-600">30 November 2023 | 10:00 WIB</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- User Book Submission -->
    <section id="submit-book" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-12 text-center animate-fade-in">Ajukan Buku Baru</h2>
            <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8 transform hover:shadow-xl transition-all duration-300">
                <form id="submission-form" class="space-y-6">
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Judul Buku</label>
                        <input type="text" id="submission-title" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Penulis</label>
                        <input type="text" id="submission-author" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">ISBN</label>
                        <input type="text" id="submission-isbn" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Kategori</label>
                        <select id="submission-category" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Pelajaran">Buku Pelajaran</option>
                            <option value="Fiksi">Fiksi</option>
                            <option value="Non-Fiksi">Non-Fiksi</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Tingkat Pendidikan</label>
                        <select id="submission-level" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                            <option value="">Pilih Tingkat</option>
                            <option value="SD">SD</option>
                            <option value="SMP">SMP</option>
                            <option value="SMA">SMA</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Deskripsi</label>
                        <textarea id="submission-description" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" rows="4"></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300 flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Ajukan Buku
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Admin Section -->
    <section id="admin" class="py-16 bg-gray-50 hidden">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-12 text-center animate-fade-in">Area Admin</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Book Management -->
                <div class="bg-white rounded-lg shadow-lg p-8 transform hover:shadow-xl transition-all duration-300">
                    <h3 class="font-bold text-xl mb-4">Manajemen Buku</h3>
                
                    <!-- Form Tambah Buku -->
                    <form id="form-buku" class="space-y-6">
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Judul Buku</label>
                        <input type="text" id="judul" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Penulis</label>
                        <input type="text" id="penulis" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">Kategori</label>
                        <select id="kategori" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                            <option value="fiksi">Fiksi</option>
                            <option value="non-fiksi">Non-Fiksi</option>
                            <option value="pelajaran">Buku Pelajaran</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-gray-700 mb-2 font-medium">ISBN</label>
                        <input type="text" id="isbn" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all duration-300" required>
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="submit" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-8 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300 flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i>
                            Tambah Buku
                        </button>
                    </div>
                </form>
                </div>

                <!-- Submissions Review -->
                <div class="bg-white rounded-lg shadow-lg p-8 transform hover:shadow-xl transition-all duration-300">
                    <h3 class="font-bold text-xl mb-4">Review Pengajuan Buku</h3>
                    <div id="submissions-list" class="space-y-4">
                        <!-- Submissions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">Kontak Kami</h3>
                    <div class="space-y-2">
                        <p><i class="fas fa-phone mr-2"></i> (021) 1234-5678</p>
                        <p><i class="fas fa-envelope mr-2"></i> perpustakaan@sekolah.edu</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Alamat</h3>
                    <p>Jl. Pendidikan No. 123<br>
                    Kota Jakarta, 12345<br>
                    Indonesia</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Media Sosial</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="hover:text-blue-400"><i class="fab fa-facebook fa-2x"></i></a>
                        <a href="#" class="hover:text-blue-400"><i class="fab fa-twitter fa-2x"></i></a>
                        <a href="#" class="hover:text-blue-400"><i class="fab fa-instagram fa-2x"></i></a>
                    </div>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-700 text-center">
                <p>&copy; 2023 Perpustakaan Sekolah. Hak Cipta Dilindungi.</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript untuk manajemen buku dan autentikasi -->
    <script>
        // Check authentication status on page load
        let session = null;

        async function checkAuth() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                const loginLink = document.getElementById('login-link');
                const adminLink = document.getElementById('admin-link');
                const logoutBtn = document.getElementById('logout-btn');
                const adminSection = document.getElementById('admin');
                const usernameDisplay = document.getElementById('username-display');
                const submitBookLink = document.getElementById('submit-book-link');
                
                if (data.authenticated) {
                    session = data;
                    loginLink.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    usernameDisplay.querySelector('span').textContent = data.username;
                    usernameDisplay.classList.remove('hidden');
                    submitBookLink.classList.remove('hidden');
                    
                    if (data.role === 'admin') {
                        adminLink.classList.remove('hidden');
                        adminSection.classList.remove('hidden');
                    } else {
                        adminLink.classList.add('hidden');
                        adminSection.classList.add('hidden');
                    }
                } else {
                    session = null;
                    loginLink.classList.remove('hidden');
                    adminLink.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    adminSection.classList.add('hidden');
                    usernameDisplay.classList.add('hidden');
                    submitBookLink.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                session = null;
            }
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // Fungsi untuk menampilkan buku
        async function tampilkanBuku() {
            try {
                const daftarBuku = document.getElementById('daftar-buku');
                daftarBuku.innerHTML = '';

                const response = await fetch('/api/books');
                if (!response.ok) {
                    throw new Error('Failed to fetch books');
                }
                const bukuList = await response.json();
                
                if (!Array.isArray(bukuList)) {
                    console.error('Expected array of books, got:', bukuList);
                    return;
                }
                
                bukuList.forEach(buku => {
            const bukuElement = document.createElement('div');
            bukuElement.className = 'bg-white rounded-lg shadow-lg p-6 transform hover:scale-105 transition-all duration-300 border border-gray-100';
            
            const ratingStars = '★'.repeat(Math.round(buku.avg_rating)) + '☆'.repeat(5 - Math.round(buku.avg_rating));
            const stockStatus = buku.stock > 0 ? 
                `<span class="text-green-600">Tersedia (${buku.stock})</span>` : 
                '<span class="text-red-600">Tidak Tersedia</span>';
            
            bukuElement.innerHTML = `
                <div class="relative">
                    <span class="absolute top-0 right-0 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                        ${buku.education_level}
                    </span>
                    <h3 class="font-bold text-xl mb-2">${buku.title}</h3>
                    <p class="text-gray-600">Penulis: ${buku.author}</p>
                    <p class="text-gray-600">Kategori: ${buku.category}</p>
                    <p class="text-gray-600">Penerbit: ${buku.publisher || '-'}</p>
                    <p class="text-sm text-yellow-500 my-2">${ratingStars} (${buku.review_count} ulasan)</p>
                    <p class="text-gray-600 mb-2">${stockStatus}</p>
                    <div class="flex justify-between items-center mt-4">
                        <button onclick="showBookDetails(${buku.id})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-info-circle"></i> Detail
                        </button>
                        ${window.session?.role === 'admin' ? `
                            <button onclick="hapusBuku('${buku.isbn}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
                    daftarBuku.appendChild(bukuElement);
                });
            } catch (error) {
                console.error('Error displaying books:', error);
                const daftarBuku = document.getElementById('daftar-buku');
                daftarBuku.innerHTML = '<p class="text-red-500 text-center">Gagal memuat daftar buku</p>';
            }
        }

        // Fungsi untuk menambah buku
        document.getElementById('form-buku').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bukuBaru = {
                judul: document.getElementById('judul').value,
                penulis: document.getElementById('penulis').value,
                kategori: document.getElementById('kategori').value,
                isbn: document.getElementById('isbn').value
            };

            try {
                const response = await fetch('/api/books', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bukuBaru)
                });

                if (response.ok) {
                    await tampilkanBuku();
                    this.reset();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Gagal menambahkan buku');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menambahkan buku');
            }
        });

        // Fungsi untuk menghapus buku
        async function hapusBuku(isbn) {
            try {
                const response = await fetch(`/api/books/${isbn}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await tampilkanBuku();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Gagal menghapus buku');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus buku');
            }
        }

        // Handle book submission
        document.getElementById('submission-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner icon-spin"></i> Mengirim...';
            submitBtn.disabled = true;
            
            const formData = {
                title: document.getElementById('submission-title').value,
                author: document.getElementById('submission-author').value,
                isbn: document.getElementById('submission-isbn').value,
                category: document.getElementById('submission-category').value,
                education_level: document.getElementById('submission-level').value,
                description: document.getElementById('submission-description').value
            };

            try {
                const response = await fetch('/api/submissions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Buku berhasil diajukan dan menunggu persetujuan admin');
                    this.reset();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Gagal mengajukan buku');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengajukan buku');
            } finally {
                submitBtn.innerHTML = originalContent;
                submitBtn.disabled = false;
            }
        });

        // Update auth check to handle submission form visibility
        async function checkAuth() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                const loginLink = document.getElementById('login-link');
                const adminLink = document.getElementById('admin-link');
                const logoutBtn = document.getElementById('logout-btn');
                const adminSection = document.getElementById('admin');
                const usernameDisplay = document.getElementById('username-display');
                const submitBookLink = document.getElementById('submit-book-link');
                
                if (data.authenticated) {
                    loginLink.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    usernameDisplay.querySelector('span').textContent = data.username;
                    usernameDisplay.classList.remove('hidden');
                    submitBookLink.classList.remove('hidden');
                    
                    if (data.role === 'admin') {
                        adminLink.classList.remove('hidden');
                        adminSection.classList.remove('hidden');
                    } else {
                        adminLink.classList.add('hidden');
                        adminSection.classList.add('hidden');
                    }
                } else {
                    loginLink.classList.remove('hidden');
                    adminLink.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    adminSection.classList.add('hidden');
                    usernameDisplay.classList.add('hidden');
                    submitBookLink.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking auth:', error);
            }
        }

        // Load and display submissions
        async function loadSubmissions() {
            try {
                const response = await fetch('/api/submissions');
                const submissions = await response.json();
                
                const submissionsList = document.getElementById('submissions-list');
                submissionsList.innerHTML = '';
                
                if (submissions.length === 0) {
                    submissionsList.innerHTML = '<p class="text-gray-500 text-center">Tidak ada pengajuan buku yang menunggu review</p>';
                    return;
                }
                
                submissions.forEach(submission => {
                    const submissionEl = document.createElement('div');
                    submissionEl.className = 'bg-gray-50 rounded-lg p-4 space-y-2';
                    submissionEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold">${submission.title}</h4>
                                <p class="text-sm text-gray-600">Oleh: ${submission.author}</p>
                                <p class="text-sm text-gray-600">Diajukan oleh: ${submission.full_name}</p>
                                <p class="text-sm text-gray-600">Kategori: ${submission.category} (${submission.education_level})</p>
                                <p class="text-sm text-gray-600">ISBN: ${submission.isbn}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="reviewSubmission(${submission.id}, 'approved')" 
                                        class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="reviewSubmission(${submission.id}, 'rejected')"
                                        class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        ${submission.description ? `<p class="text-sm text-gray-600">${submission.description}</p>` : ''}
                    `;
                    submissionsList.appendChild(submissionEl);
                });
            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        // Handle submission review
        async function reviewSubmission(submissionId, status) {
            try {
                const response = await fetch(`/api/submissions/${submissionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    await loadSubmissions();
                    if (status === 'approved') {
                        await tampilkanBuku();
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || `Gagal ${status === 'approved' ? 'menyetujui' : 'menolak'} pengajuan`);
                }
            } catch (error) {
                console.error('Error reviewing submission:', error);
                alert('Terjadi kesalahan saat memproses pengajuan');
            }
        }

        // Book Details Modal Functions
        async function showBookDetails(bookId) {
            try {
                const response = await fetch(`/api/books/${bookId}`);
                const book = await response.json();
                
                const modal = document.getElementById('book-modal');
                const modalContent = document.getElementById('modal-content');
                
                const ratingStars = '★'.repeat(Math.round(book.avg_rating)) + '☆'.repeat(5 - Math.round(book.avg_rating));
                const canBorrow = book.stock > 0 && session?.authenticated;
                
                modalContent.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <img src="${book.cover_url || 'https://via.placeholder.com/300x400?text=No+Cover'}" 
                                 alt="${book.title}" 
                                 class="w-full rounded-lg shadow-md">
                            <div class="mt-4">
                                <p class="text-yellow-500 text-lg">${ratingStars}</p>
                                <p class="text-gray-600">${book.review_count} ulasan · Dipinjam ${book.times_borrowed} kali</p>
                            </div>
                            ${session?.authenticated ? `
                                <div class="mt-4 space-y-4">
                                    <button onclick="borrowBook(${book.id})" 
                                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                            ${!canBorrow ? 'disabled' : ''}>
                                        <i class="fas fa-book-reader mr-2"></i>
                                        Pinjam Buku
                                    </button>
                                    <div class="border rounded-lg p-4">
                                        <h4 class="font-semibold mb-2">Beri Rating & Review</h4>
                                        <div class="flex items-center space-x-2 mb-2">
                                            <div class="rating-stars">
                                                ${[1,2,3,4,5].map(n => `
                                                    <span onclick="setRating(${n})" class="cursor-pointer text-2xl">
                                                        ${n <= (book.user_rating || 0) ? '★' : '☆'}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <textarea id="review-text" class="w-full p-2 border rounded-lg" 
                                                  placeholder="Tulis review Anda...">${book.user_review || ''}</textarea>
                                        <button onclick="submitReview(${book.id})" 
                                                class="mt-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                            <i class="fas fa-paper-plane mr-2"></i>
                                            Kirim Review
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold mb-4">${book.title}</h3>
                            <div class="space-y-2 mb-6">
                                <p><span class="font-semibold">Penulis:</span> ${book.author}</p>
                                <p><span class="font-semibold">Penerbit:</span> ${book.publisher}</p>
                                <p><span class="font-semibold">Tahun Terbit:</span> ${book.publication_year}</p>
                                <p><span class="font-semibold">ISBN:</span> ${book.isbn}</p>
                                <p><span class="font-semibold">Kategori:</span> ${book.category}</p>
                                <p><span class="font-semibold">Tingkat:</span> ${book.education_level}</p>
                                <p><span class="font-semibold">Bahasa:</span> ${book.language}</p>
                                <p><span class="font-semibold">Jumlah Halaman:</span> ${book.pages}</p>
                                <p><span class="font-semibold">Stok:</span> ${book.stock}</p>
                            </div>
                            <div class="mb-6">
                                <h4 class="font-semibold mb-2">Deskripsi</h4>
                                <p class="text-gray-600">${book.description}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-4">Review Pembaca</h4>
                                <div class="space-y-4">
                                    ${book.reviews.map(review => `
                                        <div class="border-b pb-4">
                                            <div class="flex items-center justify-between">
                                                <span class="font-medium">${review.username}</span>
                                                <span class="text-yellow-500">${'★'.repeat(review.rating)}</span>
                                            </div>
                                            <p class="text-gray-600 mt-1">${review.review || ''}</p>
                                            <p class="text-gray-400 text-sm mt-1">
                                                ${new Date(review.created_at).toLocaleDateString()}
                                            </p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } catch (error) {
                console.error('Error loading book details:', error);
            }
        }

        function closeBookModal() {
            const modal = document.getElementById('book-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Book borrowing function
        async function borrowBook(bookId) {
            try {
                const response = await fetch(`/api/books/${bookId}/borrow`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Buku berhasil dipinjam. Harap kembalikan sebelum ${new Date(result.due_date).toLocaleDateString()}`);
                    closeBookModal();
                    await tampilkanBuku();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Gagal meminjam buku');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat meminjam buku');
            }
        }

        // Rating and review functions
        let currentRating = 0;

        function setRating(rating) {
            currentRating = rating;
            const stars = document.querySelectorAll('.rating-stars span');
            stars.forEach((star, index) => {
                star.textContent = index < rating ? '★' : '☆';
            });
        }

        async function submitReview(bookId) {
            if (!currentRating) {
                alert('Silakan beri rating terlebih dahulu');
                return;
            }

            try {
                const response = await fetch(`/api/books/${bookId}/rate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rating: currentRating,
                        review: document.getElementById('review-text').value
                    })
                });

                if (response.ok) {
                    alert('Review berhasil dikirim');
                    await showBookDetails(bookId);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Gagal mengirim review');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengirim review');
            }
        }

        // User history function
        async function loadUserHistory() {
            try {
                const response = await fetch('/api/user/history');
                const history = await response.json();
                
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';
                
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'bg-white rounded-lg shadow p-4 flex justify-between items-center';
                    
                    const dueDate = new Date(item.due_date);
                    const isOverdue = item.status === 'borrowed' && dueDate < new Date();
                    
                    historyItem.innerHTML = `
                        <div>
                            <h4 class="font-semibold">${item.title}</h4>
                            <p class="text-gray-600">Dipinjam: ${new Date(item.borrowed_date).toLocaleDateString()}</p>
                            <p class="text-gray-600">Jatuh Tempo: ${dueDate.toLocaleDateString()}</p>
                            ${item.returned_date ? 
                                `<p class="text-green-600">Dikembalikan: ${new Date(item.returned_date).toLocaleDateString()}</p>` :
                                `<p class="${isOverdue ? 'text-red-600' : 'text-blue-600'}">
                                    Status: ${isOverdue ? 'Terlambat' : 'Dipinjam'}
                                </p>`
                            }
                        </div>
                        ${item.status === 'borrowed' ? `
                            <button onclick="returnBook(${item.id})" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-undo mr-2"></i>
                                Kembalikan
                            </button>
                        ` : ''}
                    `;
                    historyList.appendChild(historyItem);
                });
                
                document.getElementById('user-history').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading user history:', error);
            }
        }

        // Return book function
        async function returnBook(bookId) {
            try {
                const response = await fetch(`/api/books/${bookId}/return`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Buku berhasil dikembalikan');
                    await loadUserHistory();
                    await tampilkanBuku();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Gagal mengembalikan buku');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengembalikan buku');
            }
        }

        // Initialize page with animation
        window.onload = async function() {
            document.querySelectorAll('.animate-fade-in').forEach((el, i) => {
                el.style.animationDelay = `${i * 0.1}s`;
            });
            await checkAuth();
            await tampilkanBuku();
            if (session?.role === 'admin') {
                await loadSubmissions();
            }
            if (session?.user_id) {
                await loadUserHistory();
            }
        };
    </script>
</body>
</html>
